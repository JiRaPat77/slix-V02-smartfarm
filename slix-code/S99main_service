#!/bin/sh
### BEGIN INIT INFO
# Provides:          main_service
# Required-Start:    $remote_fs $network
# Required-Stop:     $remote_fs $network
# Default-Start:     2 3 4 5
# Default-Stop:      0 1 6
# Short-Description: Autostart Python main service
### END INIT INFO

NAME="main_service"
DAEMON="/usr/bin/python3"
APP="/root/test_main04.py"
PIDFILE="/var/run/${NAME}.pid"


LOG_DIR="/userdata/logs"
LOGFILE="${LOG_DIR}/${NAME}_$(date +%Y-%m-%d).log"

start() {
    echo "Starting $NAME..."
    if [ -f "$PIDFILE" ] && kill -0 "$(cat "$PIDFILE" 2>/dev/null)" 2>/dev/null; then
        echo "$NAME already running with PID $(cat "$PIDFILE")"
        return 0
    fi
    
 
    mkdir -p "$LOG_DIR" /var/run
    
    # ?? log ???????? 30 ???
    find "$LOG_DIR" -name "${NAME}_*.log" -type f -mtime +30 -delete 2>/dev/null
    
    touch "$LOGFILE"
    echo "========================================" >> "$LOGFILE"
    echo "Service started: $(date '+%Y-%m-%d %H:%M:%S')" >> "$LOGFILE"
    echo "========================================" >> "$LOGFILE"
    
    nohup "$DAEMON" "$APP" >> "$LOGFILE" 2>&1 &
    echo $! > "$PIDFILE"
    echo "$NAME started with PID $(cat "$PIDFILE")"
    echo "Log file: $LOGFILE"
    echo "View log: tail -f $LOGFILE"
}

stop() {
    echo "Stopping $NAME..."
    if [ -f "$PIDFILE" ]; then
        PID="$(cat "$PIDFILE" 2>/dev/null)"
        if [ -n "$PID" ] && kill -0 "$PID" 2>/dev/null; then
            kill "$PID"
            rm -f "$PIDFILE"
            echo "Stopped."
        else
            echo "Process not running."
            rm -f "$PIDFILE"
        fi
    else
        echo "No PID file found."
    fi
}

status() {
    if [ -f "$PIDFILE" ] && kill -0 "$(cat "$PIDFILE" 2>/dev/null)" 2>/dev/null; then
        echo "$NAME is running with PID $(cat "$PIDFILE")"
        exit 0
    else
        echo "$NAME is not running"
        exit 3
    fi
}

restart() {
    stop
    sleep 1
    start
}

case "$1" in
    start) start ;;
    stop) stop ;;
    restart) restart ;;
    status) status ;;
    *) echo "Usage: $0 {start|stop|restart|status}"; exit 1 ;;
esac

exit 0
